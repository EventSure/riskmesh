<!DOCTYPE html>
<!-- saved from url=(0063)file:///Users/jakekim/Downloads/openparametric-hackathon_2.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenParametric â€” On-chain Parametric Insurance Infrastructure</title>
<link rel="preconnect" href="https://fonts.googleapis.com/">
<link href="./OpenParametric â€” On-chain Parametric Insurance Infrastructure 260222 R0_files/css2" rel="stylesheet">
<script src="./OpenParametric â€” On-chain Parametric Insurance Infrastructure 260222 R0_files/chart.umd.min.js"></script>
<style>
:root {
  --bg: #0B1120;
  --card: #111827;
  --card2: #0d1626;
  --primary: #9945FF;
  --accent: #14F195;
  --danger: #EF4444;
  --success: #22C55E;
  --warning: #F59E0B;
  --text: #F8FAFC;
  --sub: #94A3B8;
  --border: #1F2937;
  --border2: #263045;
  --gp: rgba(153,69,255,0.25);
  --ga: rgba(20,241,149,0.25);
  --gd: rgba(239,68,68,0.25);
}
*{box-sizing:border-box;margin:0;padding:0;}
html{font-size:14px;}
body{font-family:'Space Grotesk',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
.mono{font-family:'DM Mono',monospace;}
.sub{color:var(--sub);}

/* noise */
body::after{content:'';position:fixed;inset:0;background:url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.025'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:.5;}

/* â•â•â• SCROLLBAR â•â•â• */
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}

/* â•â•â• HEADER â•â•â• */
.header{background:rgba(11,17,32,.97);border-bottom:1px solid var(--border);padding:0 20px;position:sticky;top:0;z-index:100;backdrop-filter:blur(16px);}
.header-top{display:flex;align-items:center;justify-content:space-between;padding:12px 0 10px;border-bottom:1px solid var(--border);}
.logo{display:flex;align-items:center;gap:10px;}
.logo-mark{width:32px;height:32px;background:linear-gradient(135deg,var(--primary),var(--accent));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;box-shadow:0 0 20px var(--gp);}
.logo-name{font-size:16px;font-weight:700;letter-spacing:.03em;}
.logo-sub{font-size:10px;color:var(--sub);letter-spacing:.1em;text-transform:uppercase;margin-top:1px;}
.header-right{display:flex;align-items:center;gap:10px;}

/* Role switcher */
.role-select{background:var(--card);border:1px solid var(--border);color:var(--text);font-family:'Space Grotesk',sans-serif;font-size:12px;font-weight:600;padding:6px 28px 6px 10px;border-radius:8px;outline:none;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='7'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%2394A3B8' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;}
.role-badge{padding:4px 10px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;font-family:'DM Mono',monospace;}
.badge-live{background:rgba(20,241,149,.1);color:var(--accent);border:1px solid rgba(20,241,149,.3);animation:blink 2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.6}}
.net-pill{display:flex;align-items:center;gap:6px;background:var(--card);border:1px solid var(--border);border-radius:20px;padding:4px 12px;font-size:11px;font-family:'DM Mono',monospace;}
.net-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);box-shadow:0 0 6px var(--accent);animation:blink 2s infinite;}

/* KPI Bar */
.kpi-bar{display:flex;padding:8px 0;}
.kpi{flex:1;padding:6px 16px;border-right:1px solid var(--border);}
.kpi:first-child{padding-left:0;}
.kpi:last-child{border-right:none;}
.kpi-lbl{font-size:9px;text-transform:uppercase;letter-spacing:.1em;color:var(--sub);margin-bottom:2px;}
.kpi-val{font-family:'DM Mono',monospace;font-size:16px;font-weight:500;transition:color .4s;}
.kpi-val.flash{color:var(--accent);}

/* â•â•â• MAIN LAYOUT â•â•â• */
.main{display:grid;grid-template-columns:300px 1fr 300px;gap:0;height:calc(100vh - 106px);min-height:600px;}
.col{overflow-y:auto;border-right:1px solid var(--border);padding:14px;}
.col:last-child{border-right:none;}

/* â•â•â• CARDS â•â•â• */
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;margin-bottom:12px;overflow:hidden;}
.card-hdr{padding:11px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.card-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--sub);}
.card-body{padding:14px;}

/* â•â•â• FORMS â•â•â• */
.fg{margin-bottom:10px;}
.fl{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;color:var(--sub);margin-bottom:4px;display:block;}
.fi{width:100%;padding:8px 10px;background:var(--card2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;outline:none;transition:border-color .2s;}
.fi:focus{border-color:var(--primary);}
.fsel{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='7'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%2394A3B8' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;background-color:var(--card2);padding-right:28px;}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:8px;}

/* â•â•â• STAT ROWS â•â•â• */
.srow{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--card2);border-radius:8px;margin-bottom:5px;border:1px solid var(--border);}
.srow-lbl{font-size:11px;color:var(--sub);}
.srow-val{font-family:'DM Mono',monospace;font-size:12px;font-weight:500;color:var(--accent);}

/* â•â•â• BUTTONS â•â•â• */
.btn{padding:8px 14px;border-radius:8px;border:none;font-family:'Space Grotesk',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;letter-spacing:.02em;display:inline-flex;align-items:center;gap:6px;}
.btn-p{background:var(--primary);color:#fff;box-shadow:0 0 14px var(--gp);}
.btn-p:hover{box-shadow:0 0 24px rgba(153,69,255,.5);transform:translateY(-1px);}
.btn-a{background:var(--accent);color:#0B1120;font-weight:700;}
.btn-a:hover{box-shadow:0 0 20px var(--ga);transform:translateY(-1px);}
.btn-o{background:transparent;color:var(--text);border:1px solid var(--border);}
.btn-o:hover{border-color:var(--primary);color:var(--primary);}
.btn-d{background:var(--danger);color:#fff;}
.btn-w{background:var(--warning);color:#0B1120;}
.btn-sm{padding:5px 10px;font-size:11px;border-radius:6px;}
.btn-full{width:100%;justify-content:center;}
.btn:disabled{opacity:.3;cursor:not-allowed;transform:none!important;box-shadow:none!important;}

/* â•â•â• STATE MACHINE â•â•â• */
.sm-wrap{padding:16px 14px 10px;overflow-x:auto;}
.sm-track{display:flex;align-items:flex-start;gap:0;min-width:560px;}
.sm-node{display:flex;flex-direction:column;align-items:center;flex:1;gap:6px;}
.sm-circle{width:36px;height:36px;border-radius:50%;border:2px solid var(--border);background:var(--card2);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--sub);transition:all .5s;z-index:2;position:relative;}
.sm-circle.done{border-color:var(--success);background:rgba(34,197,94,.12);color:var(--success);box-shadow:0 0 12px rgba(34,197,94,.3);}
.sm-circle.cur{border-color:var(--primary);background:rgba(153,69,255,.18);color:var(--primary);box-shadow:0 0 18px var(--gp);animation:pulse-p 2s infinite;}
.sm-circle.claimable{border-color:var(--warning);background:rgba(245,158,11,.18);color:var(--warning);box-shadow:0 0 18px rgba(245,158,11,.3);animation:pulse-w 1.5s infinite;}
.sm-circle.settled{border-color:var(--accent);background:rgba(20,241,149,.12);color:var(--accent);box-shadow:0 0 18px var(--ga);}
.sm-circle.expired{border-color:var(--sub);background:rgba(148,163,184,.08);color:var(--sub);}
@keyframes pulse-p{0%,100%{box-shadow:0 0 18px var(--gp)}50%{box-shadow:0 0 32px rgba(153,69,255,.6)}}
@keyframes pulse-w{0%,100%{box-shadow:0 0 18px rgba(245,158,11,.3)}50%{box-shadow:0 0 32px rgba(245,158,11,.6)}}
.sm-lbl{font-size:9px;font-weight:600;letter-spacing:.04em;color:var(--sub);text-align:center;transition:color .4s;}
.sm-lbl.cur{color:var(--primary);}
.sm-lbl.done{color:var(--success);}
.sm-lbl.claimable{color:var(--warning);}
.sm-lbl.settled{color:var(--accent);}
.sm-conn{flex:1;height:2px;background:var(--border);margin-top:17px;z-index:1;transition:background .5s;min-width:8px;}
.sm-conn.done{background:var(--success);}

/* â•â•â• DEMO RUNNER â•â•â• */
.step-item{background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin-bottom:8px;transition:all .3s;}
.step-item.active{border-color:var(--primary);background:rgba(153,69,255,.06);}
.step-item.done-step{border-color:var(--success);background:rgba(34,197,94,.05);}
.step-item.error-step{border-color:var(--danger);}
.step-hdr{display:flex;align-items:center;gap:8px;margin-bottom:4px;}
.step-num{width:20px;height:20px;border-radius:50%;background:var(--border);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0;}
.step-num.done-n{background:var(--success);color:#0B1120;}
.step-num.cur-n{background:var(--primary);color:#fff;}
.step-name{font-size:12px;font-weight:700;font-family:'DM Mono',monospace;}
.step-role{font-size:10px;padding:2px 6px;border-radius:4px;font-weight:600;font-family:'DM Mono',monospace;}
.step-detail{font-size:10px;color:var(--sub);line-height:1.6;padding-left:28px;}
.step-checks{margin-top:6px;padding-left:28px;}
.check-item{font-size:10px;display:flex;align-items:center;gap:5px;margin-bottom:2px;}
.check-ok{color:var(--success);}
.check-fail{color:var(--danger);}

/* â•â•â• PARTICIPANTS â•â•â• */
.pt-row{background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin-bottom:8px;transition:border-color .3s;}
.pt-row.committed{border-color:rgba(153,69,255,.35);}
.pt-row.funded{border-color:rgba(20,241,149,.35);}
.pt-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;}
.pt-name{display:flex;align-items:center;gap:7px;font-size:12px;font-weight:600;}
.pt-dot{width:7px;height:7px;border-radius:50%;}
.pt-chip{font-size:9px;padding:2px 7px;border-radius:5px;font-weight:700;text-transform:uppercase;letter-spacing:.04em;font-family:'DM Mono',monospace;}

/* â•â•â• PROGRESS â•â•â• */
.progwrap{height:5px;background:var(--card2);border-radius:3px;overflow:hidden;margin-bottom:3px;}
.progfill{height:100%;border-radius:3px;transition:width .8s cubic-bezier(.34,1.56,.64,1);}
.prog-lbl{display:flex;justify-content:space-between;font-size:9px;color:var(--sub);font-family:'DM Mono',monospace;margin-bottom:3px;}

/* â•â•â• INSPECTOR â•â•â• */
.inspector-account{background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin-bottom:8px;}
.ia-hdr{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.ia-icon{width:26px;height:26px;border-radius:6px;background:rgba(153,69,255,.15);border:1px solid rgba(153,69,255,.3);display:flex;align-items:center;justify-content:center;font-size:11px;}
.ia-name{font-size:11px;font-weight:700;font-family:'DM Mono',monospace;}
.ia-pda{font-size:9px;color:var(--sub);font-family:'DM Mono',monospace;margin-top:1px;word-break:break-all;}
.ia-field{display:flex;justify-content:space-between;align-items:flex-start;padding:3px 0;border-bottom:1px solid rgba(31,41,55,.5);}
.ia-field:last-child{border-bottom:none;}
.ia-key{font-size:10px;color:var(--sub);font-family:'DM Mono',monospace;flex-shrink:0;margin-right:8px;}
.ia-val{font-size:10px;font-family:'DM Mono',monospace;text-align:right;word-break:break-all;color:var(--text);}
.ia-val.accent{color:var(--accent);}
.ia-val.warn{color:var(--warning);}
.ia-val.danger{color:var(--danger);}

/* â•â•â• PDA seeds â•â•â• */
.pda-seed{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;}
.seed-chip{padding:2px 7px;background:rgba(153,69,255,.1);border:1px solid rgba(153,69,255,.25);border-radius:4px;font-size:9px;font-family:'DM Mono',monospace;color:var(--primary);}

/* â•â•â• EVENT LOG â•â•â• */
.bottom-section{border-top:1px solid var(--border);height:220px;display:flex;gap:0;}
.log-col{flex:1;overflow-y:auto;padding:12px 14px;border-right:1px solid var(--border);}
.log-col:last-child{border-right:none;}
.log-entry{display:flex;gap:8px;align-items:flex-start;padding:5px 0;border-bottom:1px solid rgba(31,41,55,.4);animation:log-in .3s ease;}
@keyframes log-in{from{opacity:0;transform:translateX(-6px)}to{opacity:1;transform:translateX(0)}}
.log-dot{width:5px;height:5px;border-radius:50%;margin-top:5px;flex-shrink:0;}
.log-time{font-family:'DM Mono',monospace;font-size:9px;color:var(--sub);white-space:nowrap;padding-top:1px;}
.log-body{font-size:11px;color:var(--text);}
.log-detail{font-size:10px;color:var(--sub);margin-top:1px;}

/* â•â•â• ORACLE MODAL â•â•â• */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:500;backdrop-filter:blur(6px);align-items:center;justify-content:center;}
.modal-ov.show{display:flex;}
.modal{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;width:480px;max-width:95vw;box-shadow:0 0 80px rgba(0,0,0,.6);animation:modal-in .3s cubic-bezier(.34,1.56,.64,1);}
@keyframes modal-in{from{opacity:0;transform:scale(.88) translateY(16px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-title{font-size:15px;font-weight:700;margin-bottom:4px;}
.modal-sub{font-size:11px;color:var(--sub);margin-bottom:16px;}
.error-box{padding:10px 12px;border-radius:8px;border:1px solid var(--danger);background:rgba(239,68,68,.08);margin-bottom:12px;display:none;}
.error-code{font-family:'DM Mono',monospace;font-size:11px;font-weight:700;color:var(--danger);}
.error-msg{font-size:11px;color:var(--sub);margin-top:2px;}
.success-box{padding:10px 12px;border-radius:8px;border:1px solid var(--success);background:rgba(34,197,94,.08);margin-bottom:12px;display:none;}

/* Comparison panel */
.cmp-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;}
.cmp-panel{border-radius:10px;padding:12px;border:1px solid;}
.cmp-trad{border-color:rgba(148,163,184,.25);background:rgba(148,163,184,.04);}
.cmp-chain{border-color:rgba(153,69,255,.35);background:rgba(153,69,255,.07);}
.cmp-title{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;margin-bottom:7px;}
.cmp-trad .cmp-title{color:var(--sub);}
.cmp-chain .cmp-title{color:var(--primary);}
.cmp-item{font-size:10px;margin-bottom:4px;display:flex;align-items:center;gap:5px;}
.cmp-item::before{content:'';width:4px;height:4px;border-radius:50%;background:currentColor;flex-shrink:0;}
.cmp-trad .cmp-item{color:var(--danger);}
.cmp-chain .cmp-item{color:var(--success);}

/* â•â•â• TOAST â•â•â• */
.toast{position:fixed;bottom:20px;right:20px;z-index:600;padding:11px 16px;border-radius:10px;font-size:12px;font-weight:500;box-shadow:0 8px 28px rgba(0,0,0,.35);animation:toast-in .4s cubic-bezier(.34,1.56,.64,1);display:none;align-items:center;gap:8px;max-width:320px;}
.toast.show{display:flex;}
.toast.s{background:rgba(34,197,94,.16);border:1px solid rgba(34,197,94,.35);color:var(--success);}
.toast.w{background:rgba(245,158,11,.16);border:1px solid rgba(245,158,11,.35);color:var(--warning);}
.toast.i{background:rgba(153,69,255,.16);border:1px solid rgba(153,69,255,.35);color:var(--primary);}
.toast.d{background:rgba(239,68,68,.16);border:1px solid rgba(239,68,68,.35);color:var(--danger);}
@keyframes toast-in{from{opacity:0;transform:translateX(32px)}to{opacity:1;transform:translateX(0)}}

/* â•â•â• DIVIDER â•â•â• */
.div{height:1px;background:var(--border);margin:10px 0;}

/* â•â•â• RISK TOKEN â•â•â• */
.token-toggle{display:flex;align-items:center;gap:8px;padding:8px 10px;background:rgba(153,69,255,.08);border:1px solid rgba(153,69,255,.2);border-radius:8px;cursor:pointer;margin-bottom:10px;}
.toggle-sw{width:32px;height:18px;border-radius:9px;background:var(--border);position:relative;transition:background .3s;flex-shrink:0;}
.toggle-sw::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;border-radius:50%;background:#fff;transition:transform .3s;}
.toggle-sw.on{background:var(--primary);}
.toggle-sw.on::after{transform:translateX(14px);}
.token-lbl{font-size:11px;font-weight:600;}
.token-hint{font-size:9px;color:var(--sub);margin-top:1px;}

/* â•â•â• MISC â•â•â• */
.danger-flash{position:fixed;inset:0;pointer-events:none;background:rgba(239,68,68,.06);z-index:9998;animation:dflash 1.2s ease forwards;}
@keyframes dflash{0%{opacity:0}25%{opacity:1}100%{opacity:0}}
.glow-card{animation:gcard .8s ease forwards;}
@keyframes gcard{0%{box-shadow:0 0 0 rgba(153,69,255,0)}50%{box-shadow:0 0 40px rgba(153,69,255,.4)}100%{box-shadow:0 0 10px rgba(153,69,255,.1)}}
.tag{display:inline-flex;align-items:center;padding:2px 7px;border-radius:5px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;font-family:'DM Mono',monospace;}
.tag-p{background:rgba(153,69,255,.12);color:var(--primary);border:1px solid rgba(153,69,255,.3);}
.tag-a{background:rgba(20,241,149,.12);color:var(--accent);border:1px solid rgba(20,241,149,.3);}
.tag-w{background:rgba(245,158,11,.12);color:var(--warning);border:1px solid rgba(245,158,11,.3);}
.tag-d{background:rgba(239,68,68,.12);color:var(--danger);border:1px solid rgba(239,68,68,.3);}
.tag-s{background:rgba(148,163,184,.1);color:var(--sub);border:1px solid rgba(148,163,184,.2);}
</style>
</head>
<body>

<!-- â•â•â• HEADER â•â•â• -->
<div class="header">
  <div class="header-top">
    <div class="logo">
      <div class="logo-mark">OP</div>
      <div>
        <div class="logo-name">OpenParametric Protocol</div>
        <div class="logo-sub">On-chain Parametric Insurance Â· Solana Devnet</div>
      </div>
    </div>
    <div class="header-right">
      <div class="net-pill"><div class="net-dot"></div>devnet</div>
      <select class="role-select" id="roleSelect" onchange="setRole(this.value)">
        <option value="leader">ğŸ‘‘ Leader (Insurer)</option>
        <option value="partA">ğŸ”µ Participant A</option>
        <option value="partB">ğŸŸ¡ Participant B</option>
        <option value="operator">ğŸ›¡ï¸ Operator/Admin</option>
      </select>
      <span class="role-badge badge-live">â— LIVE DEMO</span>
    </div>
  </div>
  <div class="kpi-bar">
    <div class="kpi"><div class="kpi-lbl">Active Policies</div><div class="kpi-val mono" id="kpiActive">0</div></div>
    <div class="kpi"><div class="kpi-lbl">Total Locked Capital</div><div class="kpi-val mono" id="kpiLocked">0</div></div>
    <div class="kpi"><div class="kpi-lbl">Total Exposure</div><div class="kpi-val mono" id="kpiExposure">0</div></div>
    <div class="kpi"><div class="kpi-lbl">Total Paid Out</div><div class="kpi-val mono" id="kpiPaidOut">0</div></div>
    <div class="kpi"><div class="kpi-lbl">Pool Health</div><div class="kpi-val mono" id="kpiHealth">â€”</div></div>
  </div>
</div>

<!-- â•â•â• MAIN â•â•â• -->
<div class="main">

  <!-- LEFT COL: Policy Builder + Details -->
  <div class="col" id="leftCol">

    <!-- Policy Builder -->
    <div class="card" id="builderCard">
      <div class="card-hdr">
        <span class="card-title">Policy Builder</span>
        <span class="mono sub" style="font-size:10px;" id="policyIdDisplay">POL-â€”</span>
      </div>
      <div class="card-body" style="opacity: 1; pointer-events: auto;">
        <div class="row2">
          <div class="fg"><label class="fl">Policy ID</label><input class="fi mono" id="fPolicyId" value="1001" type="number"></div>
          <div class="fg"><label class="fl">Flight No.</label><input class="fi mono" id="fFlightNo" value="KE081"></div>
        </div>
        <div class="fg"><label class="fl">Route</label><input class="fi mono" id="fRoute" value="ICN-JFK"></div>
        <div class="fg"><label class="fl">Departure Date (UTC)</label><input class="fi mono" id="fDepDate" value="2026-03-15T10:00:00Z"></div>
        <div class="row2">
          <div class="fg"><label class="fl">Delay Threshold (min)</label><input class="fi mono" id="fThreshold" value="120" type="number" min="0" max="600"></div>
          <div class="fg"><label class="fl">Payout Amount (USDC)</label><input class="fi mono" id="fPayout" value="1000000" type="number"></div>
        </div>
        <div class="fg">
          <label class="fl">Currency Mint</label>
          <input class="fi mono" id="fMint" value="EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v" readonly="" style="font-size:10px;opacity:.7;">
        </div>
        <div class="fg">
          <label class="fl">Oracle Feed</label>
          <input class="fi mono" id="fOracle" value="SwitchboardFeed1aFlight1ICN1JFK1KE081xxxx" readonly="" style="font-size:10px;opacity:.7;">
        </div>
        <div class="div"></div>
        <button class="btn btn-p btn-full" id="btnCreate" onclick="step_createPolicy()" disabled="">
          ğŸ“„ create_policy
        </button>
      </div>
    </div>

    <!-- Policy Details -->
    <div class="card" id="policyDetailsCard" style="display: none;">
      <div class="card-hdr">
        <span class="card-title">Policy Account</span>
        <span class="tag tag-a" id="policyStateBadge">SETTLED</span>
      </div>
      <div class="card-body">
        <div class="srow"><span class="srow-lbl">policy_id</span><span class="srow-val" id="dPolicyId">1001</span></div>
        <div class="srow"><span class="srow-lbl">flight_no</span><span class="srow-val" id="dFlightNo">KE081</span></div>
        <div class="srow"><span class="srow-lbl">route</span><span class="srow-val" id="dRoute">ICN-JFK</span></div>
        <div class="srow"><span class="srow-lbl">delay_threshold</span><span class="srow-val" id="dThreshold">120 min</span></div>
        <div class="srow"><span class="srow-lbl">payout_amount</span><span class="srow-val" id="dPayout">1,000,000 USDC</span></div>
        <div class="srow"><span class="srow-lbl">departure_date</span><span class="srow-val" id="dDepDate" style="font-size:10px;">2026-03-15T10:00:00Z</span></div>
        <div class="srow"><span class="srow-lbl">unix_timestamp</span><span class="srow-val" id="dUnixTs">1773568800</span></div>
        <div class="srow"><span class="srow-lbl">state</span><span class="srow-val" id="dState">Active</span></div>
        <div class="div"></div>
        <!-- Open Underwriting -->
        <button class="btn btn-p btn-full" id="btnOpenUW" onclick="step_openUnderwriting()" disabled="">
          ğŸ“‚ open_underwriting
        </button>
        <!-- Activate -->
        <button class="btn btn-a btn-full" id="btnActivate" onclick="step_activatePolicy()" style="margin-top:6px;" disabled="">
          âš¡ activate_policy
        </button>
        <!-- Expire -->
        <button class="btn btn-o btn-full" id="btnExpire" onclick="step_expirePolicy()" style="margin-top:6px;font-size:11px;" disabled="">
          â° expire_policy (public)
        </button>
      </div>
    </div>

    <!-- Claim Section -->
    <div class="card" id="claimCard" style="display: none;">
      <div class="card-hdr">
        <span class="card-title">Claim Account</span>
        <span class="tag tag-a" id="claimStateBadge">SETTLED</span>
      </div>
      <div class="card-body">
        <div class="srow"><span class="srow-lbl">oracle_value</span><span class="srow-val" id="cOracleVal">130 min</span></div>
        <div class="srow"><span class="srow-lbl">verified_at</span><span class="srow-val" id="cVerifiedAt" style="font-size:10px;">2026-02-22T13:59:41.754Z</span></div>
        <div class="srow"><span class="srow-lbl">approved_by</span><span class="srow-val" id="cApprovedBy" style="font-size:10px;">LeaDrXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</span></div>
        <div class="srow"><span class="srow-lbl">payout_amount</span><span class="srow-val" id="cPayoutAmt">1,000,000 USDC</span></div>
        <div class="srow"><span class="srow-lbl">status</span><span class="srow-val" id="cStatus">Settled</span></div>
        <div class="div"></div>
        <button class="btn btn-w btn-full" id="btnApproveClaim" onclick="step_approveClaim()" disabled="">
          âœ… approve_claim
        </button>
        <button class="btn btn-a btn-full" id="btnSettleClaim" onclick="step_settleClaim()" style="margin-top:6px;" disabled="">
          ğŸ’¸ settle_claim
        </button>
      </div>
    </div>

    <!-- External Ref Stub -->
    <div class="card">
      <div class="card-hdr"><span class="card-title">External Policyholder Refs (Off-chain)</span></div>
      <div class="card-body">
        <div style="font-size:9px;color:var(--sub);margin-bottom:8px;">SHA-256 hashes only. No PII stored on-chain.</div>
        <div class="srow"><span class="srow-lbl" style="font-size:9px;">ref_hash_1</span><span class="srow-val" style="font-size:9px;">a3f8e2...d91c</span></div>
        <div class="srow"><span class="srow-lbl" style="font-size:9px;">ref_hash_2</span><span class="srow-val" style="font-size:9px;">7b14cc...f302</span></div>
        <div class="srow"><span class="srow-lbl" style="font-size:9px;">ref_hash_3</span><span class="srow-val" style="font-size:9px;">c09a77...1e88</span></div>
      </div>
    </div>
  </div>

  <!-- CENTER COL: State Machine + Demo Runner + Oracle -->
  <div class="col" style="border-right:1px solid var(--border);">

    <!-- State Machine -->
    <div class="card">
      <div class="card-hdr">
        <span class="card-title">Policy State Machine</span>
        <span class="mono sub" style="font-size:9px;">PolicyState enum</span>
      </div>
      <div class="sm-wrap">
        <div class="sm-track" id="smTrack"><div class="sm-node"><div class="sm-circle ">ğŸ“„</div><div class="sm-lbl ">Draft</div></div><div class="sm-conn"></div><div class="sm-node"><div class="sm-circle ">ğŸ“‚</div><div class="sm-lbl ">Open</div></div><div class="sm-conn"></div><div class="sm-node"><div class="sm-circle ">ğŸ’°</div><div class="sm-lbl ">Funded</div></div><div class="sm-conn"></div><div class="sm-node"><div class="sm-circle ">âš¡</div><div class="sm-lbl ">Active</div></div><div class="sm-conn"></div><div class="sm-node"><div class="sm-circle ">ğŸ””</div><div class="sm-lbl ">Claimable</div></div><div class="sm-conn"></div><div class="sm-node"><div class="sm-circle ">âœ…</div><div class="sm-lbl ">Approved</div></div><div class="sm-conn"></div><div class="sm-node"><div class="sm-circle ">ğŸ’¸</div><div class="sm-lbl ">Settled</div></div><div class="sm-conn"></div><div class="sm-node"><div class="sm-circle ">â°</div><div class="sm-lbl ">Expired</div></div></div>
      </div>
      <!-- Underwriting State -->
      <div style="padding:0 14px 10px;">
        <div style="font-size:9px;color:var(--sub);margin-bottom:6px;font-family:&#39;DM Mono&#39;,monospace;">UnderwritingStatus</div>
        <div class="sm-wrap" style="padding:0;">
          <div class="sm-track" id="uwTrack" style="min-width:300px;"><div class="sm-node"><div class="sm-circle ">ğŸ’¬</div><div class="sm-lbl ">Proposed</div></div><div class="sm-conn"></div><div class="sm-node"><div class="sm-circle ">ğŸ“‚</div><div class="sm-lbl ">Open</div></div><div class="sm-conn"></div><div class="sm-node"><div class="sm-circle ">âœ…</div><div class="sm-lbl ">Finalized</div></div></div>
        </div>
      </div>
    </div>

    <!-- Demo Runner -->
    <div class="card">
      <div class="card-hdr">
        <span class="card-title">Instruction Runner</span>
        <button class="btn btn-o btn-sm" onclick="resetDemo()">â†º Reset</button>
      </div>
      <div class="card-body" style="padding:10px;">
        <div id="stepsList"><div class="step-item active" id="step-0">
      <div class="step-hdr">
        <div class="step-num cur-n">1</div>
        <span class="step-name">create_policy</span>
        <span class="step-role tag" style="background:#9945FF20;color:#9945FF;border:1px solid #9945FF40;">leader</span>
      </div>
      <div class="step-detail">Initializes Policy PDA. Sets all parameters.</div>
      
    </div><div class="step-item" id="step-1">
      <div class="step-hdr">
        <div class="step-num ">2</div>
        <span class="step-name">open_underwriting</span>
        <span class="step-role tag" style="background:#9945FF20;color:#9945FF;border:1px solid #9945FF40;">leader</span>
      </div>
      <div class="step-detail">Creates Underwriting PDA. Opens acceptance window.</div>
      
    </div><div class="step-item" id="step-2">
      <div class="step-hdr">
        <div class="step-num ">3</div>
        <span class="step-name">accept_share (Leader)</span>
        <span class="step-role tag" style="background:#9945FF20;color:#9945FF;border:1px solid #9945FF40;">leader</span>
      </div>
      <div class="step-detail">Leader auto-accepts 4000 bps + deposits escrow to vault.</div>
      
    </div><div class="step-item" id="step-3">
      <div class="step-hdr">
        <div class="step-num ">4</div>
        <span class="step-name">accept_share (Participant A)</span>
        <span class="step-role tag" style="background:#14F19520;color:#14F195;border:1px solid #14F19540;">partA</span>
      </div>
      <div class="step-detail">Participant A accepts 3500 bps + deposits escrow.</div>
      
    </div><div class="step-item" id="step-4">
      <div class="step-hdr">
        <div class="step-num ">5</div>
        <span class="step-name">accept_share (Participant B)</span>
        <span class="step-role tag" style="background:#F59E0B20;color:#F59E0B;border:1px solid #F59E0B40;">partB</span>
      </div>
      <div class="step-detail">Participant B accepts 2500 bps + deposits escrow.</div>
      
    </div><div class="step-item" id="step-5">
      <div class="step-hdr">
        <div class="step-num ">6</div>
        <span class="step-name">activate_policy</span>
        <span class="step-role tag" style="background:#9945FF20;color:#9945FF;border:1px solid #9945FF40;">leader</span>
      </div>
      <div class="step-detail">Verifies total_ratio==10000 &amp; vault funded. Sets Active.</div>
      
    </div><div class="step-item" id="step-6">
      <div class="step-hdr">
        <div class="step-num ">7</div>
        <span class="step-name">check_oracle_and_create_claim</span>
        <span class="step-role tag" style="background:#94A3B820;color:#94A3B8;border:1px solid #94A3B840;">public</span>
      </div>
      <div class="step-detail">Reads oracle feed. Validates freshness &amp; format. Creates Claim if delayâ‰¥threshold.</div>
      
    </div><div class="step-item" id="step-7">
      <div class="step-hdr">
        <div class="step-num ">8</div>
        <span class="step-name">approve_claim</span>
        <span class="step-role tag" style="background:#EF444420;color:#EF4444;border:1px solid #EF444440;">leader/op</span>
      </div>
      <div class="step-detail">Leader/Operator reviews and approves Claim manually.</div>
      
    </div><div class="step-item" id="step-8">
      <div class="step-hdr">
        <div class="step-num ">9</div>
        <span class="step-name">settle_claim</span>
        <span class="step-role tag" style="background:#EF444420;color:#EF4444;border:1px solid #EF444440;">leader/op</span>
      </div>
      <div class="step-detail">Transfers payout from vault. Deducts losses proportionally.</div>
      
    </div></div>
      </div>
    </div>

    <!-- Oracle Console -->
    <div class="card">
      <div class="card-hdr">
        <span class="card-title">Oracle Console</span>
        <span class="tag tag-s">Switchboard-like</span>
      </div>
      <div class="card-body">
        <div class="row2">
          <div class="fg"><label class="fl">Delay (min) â€” must be â‰¥0, Ã—10</label><input class="fi mono" id="oDelay" value="130" type="number" step="10" min="0"></div>
          <div class="fg"><label class="fl">Freshness (min ago)</label><input class="fi mono" id="oFreshness" value="5" type="number" min="0" max="60"></div>
        </div>
        <div id="oracleErrorBox" class="error-box" style="display: none;">
          <div class="error-code" id="oracleErrCode">E_ORACLE_STALE</div>
          <div class="error-msg" id="oracleErrMsg">Oracle data is too old.</div>
        </div>
        <div id="oracleSuccessBox" class="success-box" style="display: none;">
          <div style="font-size:11px;color:var(--success);font-weight:700;" id="oracleSuccessMsg">TRIGGER MET! delay_min=130 &gt;= threshold=120. Claim created.</div>
        </div>
        <button class="btn btn-p btn-full" id="btnOracle" onclick="step_checkOracle()" disabled="">
          ğŸ”® check_oracle_and_create_claim (public)
        </button>

        <div class="div"></div>
        <!-- Why blockchain -->
        <div style="font-size:9px;color:var(--sub);margin-bottom:6px;text-transform:uppercase;letter-spacing:.08em;font-weight:700;">Why On-chain?</div>
        <div class="cmp-grid">
          <div class="cmp-panel cmp-trad">
            <div class="cmp-title">Traditional</div>
            <div class="cmp-item">3â€“14 day settlement</div>
            <div class="cmp-item">Manual claims review</div>
            <div class="cmp-item">Counterparty risk</div>
            <div class="cmp-item">No audit trail</div>
          </div>
          <div class="cmp-panel cmp-chain">
            <div class="cmp-title">On-Chain (MVP)</div>
            <div class="cmp-item">Sub-1s settlement</div>
            <div class="cmp-item">Oracle-verified trigger</div>
            <div class="cmp-item">Pre-funded vault</div>
            <div class="cmp-item">Immutable audit log</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Risk Token Toggle -->
    <div class="card">
      <div class="card-hdr"><span class="card-title">Risk Token Mode (Phase 2 Preview)</span></div>
      <div class="card-body" style="padding:10px 14px;">
        <div class="token-toggle" onclick="toggleTokenMode()" id="tokenToggle">
          <div class="toggle-sw" id="tokenSw"></div>
          <div><div class="token-lbl">Enable Risk Token Preview</div><div class="token-hint">Pool represented as 1,000 tokens â€” Phase 2 tokenization preview</div></div>
        </div>
        <div id="tokenSection" style="display:none;">
          <div class="srow"><span class="srow-lbl">token_supply</span><span class="srow-val">1,000</span></div>
          <div class="srow"><span class="srow-lbl">token_value (USDC/token)</span><span class="srow-val" id="tkValue">â€”</span></div>
          <div class="srow"><span class="srow-lbl">market_cap</span><span class="srow-val" id="tkMcap">â€”</span></div>
          <div style="height:100px;margin-top:8px;"><canvas id="tokenChart"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT COL: Underwriting Pool -->
  <div class="col">

    <!-- Pool Summary -->
    <div class="card">
      <div class="card-hdr">
        <span class="card-title">RiskPool Account</span>
        <span class="tag" id="poolStateBadge" style="background: rgba(148, 163, 184, 0.1); color: rgb(148, 163, 184); border: 1px solid rgba(148, 163, 184, 0.2);">PENDING</span>
      </div>
      <div class="card-body">
        <div class="srow"><span class="srow-lbl">vault available_balance</span><span class="srow-val" id="vaultBalance">0</span></div>
        <div class="srow"><span class="srow-lbl">total_escrowed</span><span class="srow-val" id="totalEscrowed">0</span></div>
        <div class="srow"><span class="srow-lbl">payout_amount</span><span class="srow-val" id="poolPayout">â€”</span></div>
        <div class="srow"><span class="srow-lbl">total_ratio_bps</span><span class="srow-val" id="totalRatioBps">0 / 10000</span></div>
        <div class="div"></div>
        <div class="prog-lbl"><span>Collateral Funded</span><span id="fundedPct">0%</span></div>
        <div class="progwrap"><div class="progfill" id="fundedBar" style="width: 0%; background: linear-gradient(90deg,var(--primary),var(--accent));"></div></div>
        <div style="height:130px;margin-top:10px;"><canvas id="pieChart" style="box-sizing: border-box; display: block; height: 130px; width: 237px;" width="474" height="260"></canvas></div>
      </div>
    </div>

    <!-- Underwriting Participants -->
    <div class="card">
      <div class="card-hdr">
        <span class="card-title">Underwriting Participants</span>
        <span class="tag tag-a" id="uwStatusBadge">FINALIZED</span>
      </div>
      <div class="card-body" style="padding:10px;">
        <div id="ptList"><div class="pt-row ">
      <div class="pt-hdr">
        <div class="pt-name"><div class="pt-dot" style="background:#9945FF;box-shadow:0 0 5px #9945FF;"></div>Leader</div>
        <span class="pt-chip" style="background:#9945FF20;color:#9945FF;border:1px solid #9945FF40;">PROPOSED</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;font-size:10px;color:var(--sub);margin-bottom:6px;">
        <span>ratio_bps: <strong class="mono" style="color:#9945FF;">4000</strong></span>
        <span>escrow_req: <strong class="mono">0</strong></span>
        <span>escrow_dep: <strong class="mono" style="color:var(--accent);">0</strong></span>
        <span>max_loss: <strong class="mono">0</strong></span>
        
      </div>
      
      
    </div><div class="pt-row ">
      <div class="pt-hdr">
        <div class="pt-name"><div class="pt-dot" style="background:#14F195;box-shadow:0 0 5px #14F195;"></div>Participant A</div>
        <span class="pt-chip" style="background:#14F19520;color:#14F195;border:1px solid #14F19540;">PROPOSED</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;font-size:10px;color:var(--sub);margin-bottom:6px;">
        <span>ratio_bps: <strong class="mono" style="color:#14F195;">3500</strong></span>
        <span>escrow_req: <strong class="mono">0</strong></span>
        <span>escrow_dep: <strong class="mono" style="color:var(--accent);">0</strong></span>
        <span>max_loss: <strong class="mono">0</strong></span>
        
      </div>
      
      
    </div><div class="pt-row ">
      <div class="pt-hdr">
        <div class="pt-name"><div class="pt-dot" style="background:#F59E0B;box-shadow:0 0 5px #F59E0B;"></div>Participant B</div>
        <span class="pt-chip" style="background:#F59E0B20;color:#F59E0B;border:1px solid #F59E0B40;">PROPOSED</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;font-size:10px;color:var(--sub);margin-bottom:6px;">
        <span>ratio_bps: <strong class="mono" style="color:#F59E0B;">2500</strong></span>
        <span>escrow_req: <strong class="mono">0</strong></span>
        <span>escrow_dep: <strong class="mono" style="color:var(--accent);">0</strong></span>
        <span>max_loss: <strong class="mono">0</strong></span>
        
      </div>
      
      
    </div></div>
      </div>
    </div>

    <!-- Vault Chart -->
    <div class="card">
      <div class="card-hdr"><span class="card-title">Vault Balance Over Time</span></div>
      <div class="card-body" style="padding:10px;"><div style="height:130px;"><canvas id="vaultChart" style="box-sizing: border-box; display: block; height: 130px; width: 245px;" width="490" height="260"></canvas></div></div>
    </div>

    <!-- Audit View -->
    <div class="card" id="auditCard" style="display: none;">
      <div class="card-hdr"><span class="card-title">Audit Trail</span></div>
      <div class="card-body">
        <div id="auditContent"></div>
      </div>
    </div>

    <!-- On-chain Inspector -->
    <div class="card">
      <div class="card-hdr"><span class="card-title">On-chain Inspector</span><span class="mono sub" style="font-size:9px;">PDAs</span></div>
      <div class="card-body" style="padding:10px;" id="inspectorPanel"><div style="font-size:10px;color:var(--sub);text-align:center;padding:20px;">Create a policy to inspect accounts.</div></div>
    </div>
  </div>

</div>

<!-- â•â•â• BOTTOM: Event Log â•â•â• -->
<div class="bottom-section">
  <div class="log-col">
    <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--sub);margin-bottom:8px;display:flex;align-items:center;gap:6px;">
      <span style="width:5px;height:5px;border-radius:50%;background:var(--success);display:inline-block;box-shadow:0 0 6px var(--success);"></span>
      Protocol Event Log
    </div>
    <div id="eventLog"><div class="log-entry"><div class="log-dot" style="background:var(--sub);"></div><span class="log-time">--:--:--</span><div class="log-body" style="color:var(--sub);">Demo reset. Ready.</div></div></div>
  </div>
  <div class="log-col" style="max-width:340px;flex:0 0 340px;">
    <div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:var(--sub);margin-bottom:8px;">Approval / Settlement Audit</div>
    <div id="auditLog"><div style="font-size:10px;color:var(--sub);">No approval records yet.</div></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast i" id="toast"><span id="toastMsg">Demo reset</span></div>

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const POLICY_STATES = ['Draft','Open','Funded','Active','Claimable','Approved','Settled','Expired'];
const UW_STATES = ['Proposed','Open','Finalized'];
const CLAIM_STATES = ['None','Claimable','Approved','Settled','Rejected'];

const ROLES = {
  leader:   { label:'Leader (Insurer)',    color:'#9945FF', addr:'LeaDrXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX' },
  partA:    { label:'Participant A',       color:'#14F195', addr:'PartAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' },
  partB:    { label:'Participant B',       color:'#F59E0B', addr:'PartBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB' },
  operator: { label:'Operator/Admin',      color:'#EF4444', addr:'OprtXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX' },
};

let currentRole = 'leader';
let tokenModeOn = false;
let pieChartInst = null, vaultChartInst = null, tokenChartInst = null;
let vaultHistory = [];

// Main protocol state
let S = {
  policyCreated: false,
  policyId: 0,
  flightNo: '',
  route: '',
  depDate: '',
  depUnix: 0,
  threshold: 120,
  payoutAmount: 0n,
  mint: '',
  oracleFeed: '',

  policyState: -1, // index into POLICY_STATES
  uwState: -1,
  claimState: -1,

  uwOpen: false,
  participants: [
    { id:'leader', name:'Leader',        color:'#9945FF', ratioBps:4000, status:'proposed', escrow:0n, loss:0n },
    { id:'partA',  name:'Participant A', color:'#14F195', ratioBps:3500, status:'proposed', escrow:0n, loss:0n },
    { id:'partB',  name:'Participant B', color:'#F59E0B', ratioBps:2500, status:'proposed', escrow:0n, loss:0n },
  ],

  totalRatioBps: 0,
  vaultBalance: 0n,
  totalEscrowed: 0n,

  claimOracleVal: 0,
  claimVerifiedAt: '',
  claimApprovedBy: '',
  claimPayout: 0n,

  settled: false,
  paidOut: 0n,
  currentStep: 0, // 0-based step tracker
};

// Fake pubkeys using deterministic hash
function fakePubkey(seed) {
  let h = 0;
  for (let i=0; i<seed.length; i++) { h = ((h<<5)-h+seed.charCodeAt(i))|0; }
  const base58chars = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
  let addr = '';
  let n = Math.abs(h) + 1000000;
  for (let i=0; i<32; i++) { addr += base58chars[(n*i*31+i*7+h)%58]; }
  return addr.substring(0,8)+'...'+addr.substring(24,32);
}
function fakePubkeyFull(seed) {
  let h = 5381;
  for (let i=0; i<seed.length; i++) { h = ((h<<5)+h+seed.charCodeAt(i))|0; }
  const chars = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
  let addr = '';
  for (let i=0; i<44; i++) { addr += chars[Math.abs((h*i*17+i+13))%58]; }
  return addr;
}

const policyPDA = () => fakePubkeyFull('policy'+S.policyId+ROLES.leader.addr);
const uwPDA = () => fakePubkeyFull('underwriting'+policyPDA());
const poolPDA = () => fakePubkeyFull('pool'+policyPDA());
const claimPDA = () => fakePubkeyFull('claim'+policyPDA());
const vaultPDA = () => fakePubkeyFull('vault'+poolPDA());

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FORMATTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtUSDC(n) {
  if (typeof n === 'bigint') return BigInt(n).toLocaleString();
  return Number(n).toLocaleString();
}
function now() { return new Date().toLocaleTimeString('en-US',{hour12:false}); }
function nowFull() { return new Date().toISOString(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROLE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setRole(role) {
  currentRole = role;
  updateButtonPermissions();
  renderParticipants(); // re-render deposit buttons based on new role
  toast(`Switched to ${ROLES[role].label}`, 'i');
  addLog(`Role switched to ${ROLES[role].label}`, ROLES[role].color, 'role_switch');
}

function canDo(action) {
  const r = currentRole;
  const perms = {
    create_policy:    ['leader'],
    open_underwriting:['leader'],
    accept_share:     ['partA','partB','leader','operator'],
    reject_share:     ['partA','partB'],
    activate_policy:  ['leader'],
    check_oracle:     ['leader','partA','partB','operator'], // public
    approve_claim:    ['leader','operator'],
    settle_claim:     ['leader','operator'],
    expire_policy:    ['leader','partA','partB','operator'],
    refund:           ['partA','partB','leader'],
  };
  return (perms[action]||[]).includes(r);
}

function updateButtonPermissions() {
  const p = S.policyState;
  const cs = S.claimState;

  el('btnCreate').disabled   = !canDo('create_policy') || S.policyCreated;
  el('btnOpenUW').disabled   = !canDo('open_underwriting') || p !== 0; // must be Draft(0)
  el('btnActivate').disabled = !canDo('activate_policy') || p !== 2; // must be Funded(2)
  el('btnOracle').disabled   = !canDo('check_oracle') || p !== 3; // must be Active(3)
  el('btnApproveClaim').disabled = !canDo('approve_claim') || cs !== 1; // Claimable(1)
  el('btnSettleClaim').disabled  = !canDo('settle_claim') || cs !== 2;  // Approved(2)
  el('btnExpire').disabled   = !canDo('expire_policy') || (p < 3 || p > 4);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE MACHINE RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStateMachine() {
  const icons = ['ğŸ“„','ğŸ“‚','ğŸ’°','âš¡','ğŸ””','âœ…','ğŸ’¸','â°'];
  renderSMRow('smTrack', POLICY_STATES, icons, S.policyState);
  const uwIcons = ['ğŸ’¬','ğŸ“‚','âœ…'];
  renderSMRow('uwTrack', UW_STATES, uwIcons, S.uwState);
}

function renderSMRow(containerId, states, icons, curIdx) {
  const c = el(containerId); c.innerHTML='';
  states.forEach((st,i) => {
    const node = document.createElement('div'); node.className='sm-node';
    let cls = '';
    if (i < curIdx) cls='done';
    else if (i===curIdx) {
      if (st==='Claimable'||st==='Approved') cls='claimable';
      else if (st==='Settled') cls='settled';
      else cls='cur';
    }
    const lbl_cls = cls||'';
    node.innerHTML = `<div class="sm-circle ${cls}">${icons[i]||'â—'}</div><div class="sm-lbl ${lbl_cls}">${st}</div>`;
    c.appendChild(node);
    if (i < states.length-1) {
      const conn = document.createElement('div');
      conn.className = 'sm-conn'+(i<curIdx?' done':'');
      c.appendChild(conn);
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEPS RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STEPS_DEF = [
  { num:1, name:'create_policy',               role:'leader',   roleColor:'#9945FF', desc:'Initializes Policy PDA. Sets all parameters.' },
  { num:2, name:'open_underwriting',            role:'leader',   roleColor:'#9945FF', desc:'Creates Underwriting PDA. Opens acceptance window.' },
  { num:3, name:'accept_share (Leader)',        role:'leader',   roleColor:'#9945FF', desc:'Leader auto-accepts 4000 bps + deposits escrow to vault.' },
  { num:4, name:'accept_share (Participant A)', role:'partA',    roleColor:'#14F195', desc:'Participant A accepts 3500 bps + deposits escrow.' },
  { num:5, name:'accept_share (Participant B)', role:'partB',    roleColor:'#F59E0B', desc:'Participant B accepts 2500 bps + deposits escrow.' },
  { num:6, name:'activate_policy',              role:'leader',   roleColor:'#9945FF', desc:'Verifies total_ratio==10000 & vault funded. Sets Active.' },
  { num:7, name:'check_oracle_and_create_claim',role:'public',   roleColor:'#94A3B8', desc:'Reads oracle feed. Validates freshness & format. Creates Claim if delayâ‰¥threshold.' },
  { num:8, name:'approve_claim',                role:'leader/op',roleColor:'#EF4444', desc:'Leader/Operator reviews and approves Claim manually.' },
  { num:9, name:'settle_claim',                 role:'leader/op',roleColor:'#EF4444', desc:'Transfers payout from vault. Deducts losses proportionally.' },
];

function renderSteps() {
  const c = el('stepsList'); c.innerHTML='';
  STEPS_DEF.forEach((step,i) => {
    const done = i < S.currentStep;
    const cur = i === S.currentStep;
    const div = document.createElement('div');
    div.className = 'step-item'+(done?' done-step':cur?' active':'');
    div.id = 'step-'+i;

    div.innerHTML = `
      <div class="step-hdr">
        <div class="step-num ${done?'done-n':cur?'cur-n':''}">${done?'âœ“':step.num}</div>
        <span class="step-name">${step.name}</span>
        <span class="step-role tag" style="background:${step.roleColor}20;color:${step.roleColor};border:1px solid ${step.roleColor}40;">${step.role}</span>
      </div>
      <div class="step-detail">${step.desc}</div>
      ${done ? '<div class="step-checks" id="checks-'+i+'"></div>':''}
    `;
    c.appendChild(div);
  });
}

function markStepDone(idx, checks=[]) {
  S.currentStep = idx+1;
  renderSteps();
  // add checks
  const checksEl = el('checks-'+idx);
  if (checksEl) {
    checks.forEach(c => {
      const d = document.createElement('div');
      d.className='check-item check-ok';
      d.innerHTML = `<span>âœ“</span> ${c}`;
      checksEl.appendChild(d);
    });
  }
  updateButtonPermissions();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARTICIPANTS RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderParticipants() {
  const c = el('ptList'); c.innerHTML='';
  S.participants.forEach((pt,i) => {
    const escrowRequired = S.payoutAmount>0n ? S.payoutAmount * BigInt(pt.ratioBps) / 10000n : 0n;
    const statusCls = pt.status==='funded'?'funded':pt.status==='accepted'?'committed':'';
    const chipStyle = `background:${pt.color}20;color:${pt.color};border:1px solid ${pt.color}40;`;

    const roleMatch = (pt.id==='leader'&&currentRole==='leader')
      || (pt.id==='partA'&&currentRole==='partA')
      || (pt.id==='partB'&&currentRole==='partB')
      || currentRole==='operator';
    const canAccept = S.uwOpen && pt.status==='proposed' && roleMatch;

    const div = document.createElement('div');
    div.className = `pt-row ${statusCls}`;
    div.innerHTML = `
      <div class="pt-hdr">
        <div class="pt-name"><div class="pt-dot" style="background:${pt.color};box-shadow:0 0 5px ${pt.color};"></div>${pt.name}</div>
        <span class="pt-chip" style="${chipStyle}">${pt.status.toUpperCase()}</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;font-size:10px;color:var(--sub);margin-bottom:6px;">
        <span>ratio_bps: <strong class="mono" style="color:${pt.color};">${pt.ratioBps}</strong></span>
        <span>escrow_req: <strong class="mono">${fmtUSDC(escrowRequired)}</strong></span>
        <span>escrow_dep: <strong class="mono" style="color:var(--accent);">${fmtUSDC(pt.escrow)}</strong></span>
        <span>max_loss: <strong class="mono">${fmtUSDC(escrowRequired)}</strong></span>
        ${pt.loss>0n?`<span style="grid-column:1/-1;">loss_realized: <strong class="mono" style="color:var(--danger);">${fmtUSDC(pt.loss)}</strong></span>`:''}
      </div>
      ${canAccept ? `
        <div style="display:grid;grid-template-columns:1fr auto;gap:6px;">
          <input class="fi mono" id="deposit-${pt.id}" value="${fmtUSDC(escrowRequired).replace(/,/g,'')}" style="font-size:11px;padding:5px 8px;" type="number">
          <button class="btn btn-a btn-sm" onclick="step_acceptShare('${pt.id}')">Deposit</button>
        </div>` : ''}
      ${pt.status==='funded'?`<div class="progwrap" style="margin-top:5px;"><div class="progfill" style="width:100%;background:${pt.color};opacity:.7;"></div></div>`:''}
    `;
    c.appendChild(div);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ON-CHAIN INSPECTOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderInspector() {
  if (!S.policyCreated) return;
  const c = el('inspectorPanel'); c.innerHTML='';

  const accounts = [
    {
      icon:'ğŸ“„', name:'Policy', pda:`["policy", leader, ${S.policyId}]`,
      addr: policyPDA(),
      fields: [
        ['policy_id', S.policyId, ''],
        ['leader', ROLES.leader.addr.substring(0,12)+'...', ''],
        ['flight_no', S.flightNo, ''],
        ['route', S.route, ''],
        ['delay_threshold_min', S.threshold+' min', ''],
        ['payout_amount', fmtUSDC(S.payoutAmount)+' USDC', 'accent'],
        ['state', POLICY_STATES[S.policyState]||'â€”', S.policyState>=3?'accent':S.policyState<0?'':''],
        ['oracle_feed', S.oracleFeed.substring(0,16)+'...', ''],
      ]
    },
    {
      icon:'ğŸ¤', name:'Underwriting', pda:`["underwriting", policy]`,
      addr: uwPDA(),
      fields: [
        ['policy', policyPDA().substring(0,12)+'...', ''],
        ['total_ratio_bps', S.totalRatioBps+' / 10000', S.totalRatioBps===10000?'accent':'warn'],
        ['uw_status', UW_STATES[S.uwState]||'â€”', ''],
        ...S.participants.map(pt => [`ratio[${pt.name}]`, pt.ratioBps+' bps', '']),
      ]
    },
    {
      icon:'ğŸ¦', name:'RiskPool', pda:`["pool", policy]`,
      addr: poolPDA(),
      fields: [
        ['vault', vaultPDA().substring(0,12)+'...', ''],
        ['total_escrowed', fmtUSDC(S.totalEscrowed)+' USDC', 'accent'],
        ['available_balance', fmtUSDC(S.vaultBalance)+' USDC', S.vaultBalance<S.payoutAmount?'warn':'accent'],
        ['status', S.policyState>=2?'Active':'Pending', ''],
      ]
    },
  ];

  if (S.claimState>=0) {
    accounts.push({
      icon:'âš ï¸', name:'Claim', pda:`["claim", policy]`,
      addr: claimPDA(),
      fields: [
        ['oracle_value', S.claimOracleVal+' min', ''],
        ['verified_at', S.claimVerifiedAt, ''],
        ['status', CLAIM_STATES[S.claimState]||'â€”', S.claimState===3?'accent':S.claimState===4?'danger':'warn'],
        ['payout_amount', fmtUSDC(S.claimPayout)+' USDC', 'danger'],
        ['approved_by', S.claimApprovedBy?S.claimApprovedBy.substring(0,12)+'...':'â€”', ''],
      ]
    });
  }

  accounts.forEach(acc => {
    const div = document.createElement('div');
    div.className = 'inspector-account';
    div.innerHTML = `
      <div class="ia-hdr">
        <div class="ia-icon">${acc.icon}</div>
        <div><div class="ia-name">${acc.name}</div><div class="ia-pda">${acc.addr}</div></div>
      </div>
      <div class="pda-seed"><div class="seed-chip">seed:</div>${acc.pda.split(',').map(s=>`<div class="seed-chip">${s.trim().replace(/[\[\]]/g,'')}</div>`).join('')}</div>
      <div style="margin-top:8px;">
        ${acc.fields.map(([k,v,cls]) => `<div class="ia-field"><div class="ia-key">${k}</div><div class="ia-val ${cls}">${v}</div></div>`).join('')}
      </div>
    `;
    c.appendChild(div);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EVENT LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addLog(msg, color, instruction, detail='') {
  const log = el('eventLog');
  const entry = document.createElement('div');
  entry.className='log-entry';
  entry.innerHTML = `
    <div class="log-dot" style="background:${color};box-shadow:0 0 4px ${color};"></div>
    <span class="log-time">${now()}</span>
    <div>
      <div class="log-body"><strong class="mono" style="color:${color};">${instruction}</strong> ${msg}</div>
      ${detail?`<div class="log-detail">${detail}</div>`:''}
    </div>
  `;
  log.insertBefore(entry, log.firstChild);
  if (log.children.length>50) log.removeChild(log.lastChild);
}

function addAuditLog(type, data) {
  const log = el('auditLog');
  const txId = 'TX'+Math.random().toString(36).substring(2,10).toUpperCase();
  const div = document.createElement('div');
  div.style.cssText='padding:8px;background:var(--card2);border-radius:8px;border:1px solid var(--border);margin-bottom:6px;';
  div.innerHTML = `
    <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
      <span class="tag ${type==='approve'?'tag-w':'tag-a'}" style="font-size:9px;">${type.toUpperCase()}</span>
      <span class="mono sub" style="font-size:9px;">${now()}</span>
    </div>
    ${Object.entries(data).map(([k,v])=>`<div class="ia-field"><div class="ia-key">${k}</div><div class="ia-val" style="font-size:10px;">${v}</div></div>`).join('')}
    <div class="ia-field"><div class="ia-key">simulated_tx</div><div class="ia-val" style="color:var(--primary);font-size:9px;">${txId}</div></div>
  `;
  log.insertBefore(div, log.firstChild);
  const old = log.querySelector(':last-child');
  if (log.children.length>5 && old.textContent.includes('No approval')) old.remove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHARTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initPieChart() {
  const ctx = el('pieChart').getContext('2d');
  if (pieChartInst) { pieChartInst.destroy(); }
  pieChartInst = new Chart(ctx, {
    type:'doughnut',
    data:{
      labels: S.participants.map(p=>p.name),
      datasets:[{ data: S.participants.map(p=>p.ratioBps), backgroundColor: S.participants.map(p=>p.color+'99'), borderColor: S.participants.map(p=>p.color), borderWidth:1.5, hoverOffset:4 }]
    },
    options:{ responsive:true,maintainAspectRatio:false, plugins:{ legend:{ display:true, position:'bottom', labels:{ color:'#94A3B8', font:{family:'DM Mono',size:9}, padding:6, boxWidth:8 } } }, animation:{duration:500} }
  });
}

function initVaultChart() {
  const ctx = el('vaultChart').getContext('2d');
  if (vaultChartInst) { vaultChartInst.destroy(); }
  vaultChartInst = new Chart(ctx, {
    type:'line',
    data:{ labels:[], datasets:[{ label:'Vault Balance (USDC)', data:[], borderColor:'#14F195', backgroundColor:'rgba(20,241,149,.06)', borderWidth:2, fill:true, tension:.4, pointRadius:3, pointBackgroundColor:'#14F195' }] },
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:'#94A3B8',font:{family:'DM Mono',size:9}},grid:{color:'#1F2937'}},
        y:{ticks:{color:'#94A3B8',font:{family:'DM Mono',size:9},callback:v=>fmtUSDC(v)},grid:{color:'#1F2937'}}
      },
      animation:{duration:400}
    }
  });
}

function pushVaultHistory(label) {
  vaultHistory.push({ t: label||now(), v: Number(S.vaultBalance) });
  if (vaultHistory.length>20) vaultHistory.shift();
  if (vaultChartInst) {
    vaultChartInst.data.labels = vaultHistory.map(x=>x.t);
    vaultChartInst.data.datasets[0].data = vaultHistory.map(x=>x.v);
    vaultChartInst.update();
  }
}

function initTokenChart() {
  const ctx = el('tokenChart').getContext('2d');
  if (tokenChartInst) { tokenChartInst.destroy(); }
  tokenChartInst = new Chart(ctx, {
    type:'line',
    data:{ labels:[], datasets:[{ label:'Token Value', data:[], borderColor:'#9945FF', backgroundColor:'rgba(153,69,255,.06)', borderWidth:2, fill:true, tension:.4, pointRadius:2 }] },
    options:{ responsive:true,maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ x:{ticks:{color:'#94A3B8',font:{size:8}}}, y:{ticks:{color:'#94A3B8',font:{size:8}}} }, animation:{duration:300} }
  });
}

function updateTokenUI() {
  if (!tokenModeOn) return;
  const val = S.vaultBalance / 1000n;
  el('tkValue').textContent = fmtUSDC(val);
  el('tkMcap').textContent = fmtUSDC(S.vaultBalance);
  if (tokenChartInst) {
    tokenChartInst.data.labels.push(now());
    tokenChartInst.data.datasets[0].data.push(Number(val));
    if (tokenChartInst.data.labels.length>15) { tokenChartInst.data.labels.shift(); tokenChartInst.data.datasets[0].data.shift(); }
    tokenChartInst.update();
  }
}

function toggleTokenMode() {
  tokenModeOn = !tokenModeOn;
  el('tokenSw').classList.toggle('on', tokenModeOn);
  el('tokenSection').style.display = tokenModeOn?'block':'none';
  if (tokenModeOn) { initTokenChart(); updateTokenUI(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KPI UPDATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function animNum(el_id, target, dec=0) {
  const el2 = el(el_id);
  const start = parseFloat(el2.textContent.replace(/,/g,''))||0;
  const dur=600; const t0=performance.now();
  function tick(t){ const p=Math.min((t-t0)/dur,1); const e=1-Math.pow(1-p,3); el2.textContent=((start+(target-start)*e).toFixed(dec)).replace(/\B(?=(\d{3})+(?!\d))/g,','); if(p<1)requestAnimationFrame(tick); }
  requestAnimationFrame(tick);
}

function updateKPIs() {
  const isActive = S.policyState===3||S.policyState===4||S.policyState===5;
  animNum('kpiActive', isActive?1:0);
  animNum('kpiLocked', Number(S.totalEscrowed));
  animNum('kpiExposure', S.policyCreated?Number(S.payoutAmount):0);
  animNum('kpiPaidOut', Number(S.paidOut));

  const health = S.payoutAmount>0n ? Math.min(100, Math.round(Number(S.vaultBalance)*100/Number(S.payoutAmount))) : 0;
  el('kpiHealth').textContent = S.policyCreated ? health+'%' : 'â€”';
  el('kpiHealth').classList.toggle('flash', isActive);
}

function updatePoolUI() {
  el('vaultBalance').textContent = fmtUSDC(S.vaultBalance);
  el('totalEscrowed').textContent = fmtUSDC(S.totalEscrowed);
  el('poolPayout').textContent = S.payoutAmount>0n ? fmtUSDC(S.payoutAmount) : 'â€”';
  el('totalRatioBps').textContent = S.totalRatioBps+' / 10000';

  const pct = S.payoutAmount>0n ? Math.min(100, Number(S.vaultBalance)*100/Number(S.payoutAmount)) : 0;
  el('fundedBar').style.width = pct+'%';
  el('fundedPct').textContent = pct.toFixed(0)+'%';

  updateKPIs();
  renderInspector();
  updateTokenUI();

  // Pool badge
  const states=['PENDING','OPEN','FUNDED','ACTIVE','CLAIMABLE','APPROVED','SETTLED','EXPIRED'];
  const colors=['rgba(148,163,184,.1)','rgba(153,69,255,.1)','rgba(245,158,11,.1)','rgba(20,241,149,.1)','rgba(245,158,11,.1)','rgba(34,197,94,.1)','rgba(20,241,149,.1)','rgba(148,163,184,.1)'];
  const tcolors=['#94A3B8','#9945FF','#F59E0B','#14F195','#F59E0B','#22C55E','#14F195','#94A3B8'];
  const idx=Math.max(0,S.policyState);
  el('poolStateBadge').textContent=states[idx]||'PENDING';
  el('poolStateBadge').style.background=colors[idx];
  el('poolStateBadge').style.color=tcolors[idx];
}

// Policy state badge
function updatePolicyBadge() {
  const labels=['DRAFT','OPEN','FUNDED','ACTIVE','CLAIMABLE','APPROVED','SETTLED','EXPIRED'];
  const colors=['tag-s','tag-p','tag-w','tag-a','tag-w','tag-a','tag-a','tag-s'];
  if (S.policyState>=0) {
    el('policyStateBadge').textContent=labels[S.policyState];
    el('policyStateBadge').className='tag '+colors[S.policyState];
  }
  renderStateMachine();
}

// Claim badge
function updateClaimBadge() {
  const labels=['NONE','CLAIMABLE','APPROVED','SETTLED','REJECTED'];
  const css=['tag-s','tag-w','tag-a','tag-a','tag-d'];
  const idx=Math.max(0,S.claimState+1)-1;
  el('claimStateBadge').textContent=labels[Math.max(0,S.claimState)]||'NONE';
  el('claimStateBadge').className='tag '+(css[Math.max(0,S.claimState)]||'tag-s');
  el('cOracleVal').textContent=S.claimOracleVal?S.claimOracleVal+' min':'â€”';
  el('cVerifiedAt').textContent=S.claimVerifiedAt||'â€”';
  el('cApprovedBy').textContent=S.claimApprovedBy||'â€”';
  el('cPayoutAmt').textContent=S.claimPayout>0n?fmtUSDC(S.claimPayout)+' USDC':'â€”';
  el('cStatus').textContent=CLAIM_STATES[S.claimState]||'None';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INSTRUCTION STEPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function step_createPolicy() {
  if (!canDo('create_policy')) { toast('Only Leader can create_policy','d'); return; }
  const pid = parseInt(el('fPolicyId').value)||1001;
  const thr = parseInt(el('fThreshold').value)||120;
  const payout = BigInt(el('fPayout').value||'1000000');

  S.policyId = pid;
  S.flightNo = el('fFlightNo').value||'KE081';
  S.route = el('fRoute').value||'ICN-JFK';
  S.depDate = el('fDepDate').value||'2026-03-15T10:00:00Z';
  S.depUnix = Math.floor(new Date(S.depDate).getTime()/1000);
  S.threshold = thr;
  S.payoutAmount = payout;
  S.mint = el('fMint').value;
  S.oracleFeed = el('fOracle').value;

  S.policyCreated = true;
  S.policyState = 0; // Draft
  S.uwState = -1;

  el('policyIdDisplay').textContent = 'POL-'+pid;
  el('dPolicyId').textContent = pid;
  el('dFlightNo').textContent = S.flightNo;
  el('dRoute').textContent = S.route;
  el('dThreshold').textContent = thr+' min';
  el('dPayout').textContent = fmtUSDC(payout)+' USDC';
  el('dDepDate').textContent = S.depDate;
  el('dUnixTs').textContent = S.depUnix;
  el('dState').textContent = 'Draft';

  el('policyDetailsCard').style.display='block';
  el('builderCard').querySelector('.card-body').style.opacity='.5';
  el('builderCard').querySelector('.card-body').style.pointerEvents='none';

  markStepDone(0, ['Policy PDA initialized','Parameters validated','State â†’ Draft']);
  updatePolicyBadge();
  updatePoolUI();
  addLog(`POL-${pid} created. ${S.route} Â· ${S.flightNo} Â· ${fmtUSDC(payout)} USDC payout`, '#9945FF', 'create_policy', `leader: ${ROLES.leader.addr.substring(0,12)}... | pda: ${policyPDA().substring(0,16)}...`);
  toast('Policy created â€” Draft', 'i');
  renderSteps();
}

function step_openUnderwriting() {
  if (!canDo('open_underwriting')) { toast('Only Leader can open_underwriting','d'); return; }
  if (S.policyState!==0) { toast('Policy must be in Draft state','w'); return; }

  S.policyState = 1; // Open
  S.uwState = 1; // Open
  S.uwOpen = true;
  S.totalRatioBps = 0;

  markStepDone(1, ['Underwriting PDA created','Acceptance window opened','State: Draft â†’ Open']);
  el('uwStatusBadge').textContent='OPEN';
  el('uwStatusBadge').className='tag tag-p';
  updatePolicyBadge();
  updatePoolUI();
  renderParticipants();
  addLog('Underwriting window opened. 3 participants can now accept shares.', '#9945FF', 'open_underwriting', `uw_pda: ${uwPDA().substring(0,16)}...`);
  toast('Underwriting opened', 'i');
}

function step_acceptShare(ptId) {
  if (!S.uwOpen) { toast('Underwriting not open','w'); return; }
  const pt = S.participants.find(p=>p.id===ptId);
  if (!pt||pt.status!=='proposed') return;

  // Role enforcement: only matching role or operator can deposit
  const roleMatch = (ptId==='leader'&&currentRole==='leader')
    || (ptId==='partA'&&currentRole==='partA')
    || (ptId==='partB'&&currentRole==='partB')
    || currentRole==='operator';
  if (!roleMatch) { toast(`Switch to ${pt.name} role to deposit`,'d'); return; }

  const required = S.payoutAmount * BigInt(pt.ratioBps) / 10000n;
  const depositEl = el('deposit-'+ptId);
  const depositAmt = depositEl ? BigInt(depositEl.value.replace(/,/g,'')||'0') : required;

  if (depositAmt < required) { toast(`Min deposit: ${fmtUSDC(required)} USDC`,'w'); return; }

  pt.status = 'funded';
  pt.escrow = depositAmt;
  S.totalEscrowed += depositAmt;
  S.vaultBalance += depositAmt;
  S.totalRatioBps += pt.ratioBps;

  const stepIdx = ptId==='leader'?2:ptId==='partA'?3:4;
  const allFunded = S.participants.every(p=>p.status==='funded');

  // Check if all funded â†’ Funded state
  if (allFunded && S.totalRatioBps===10000 && S.vaultBalance>=S.payoutAmount) {
    S.policyState = 2; // Funded
    S.uwState = 2; // Finalized
    S.uwOpen = false;
    el('uwStatusBadge').textContent='FINALIZED';
    el('uwStatusBadge').className='tag tag-a';
    updatePolicyBadge();
    addLog('All shares accepted. total_ratio=10000. Vault funded. State â†’ Funded', '#14F195', 'underwriting_finalized');
    markStepDone(stepIdx, [`${pt.name}: ${pt.ratioBps} bps Â· ${fmtUSDC(depositAmt)} USDC deposited`,'Total ratio == 10000 âœ“','Vault >= payout_amount âœ“','State â†’ Funded']);
  } else {
    markStepDone(stepIdx, [`${pt.name}: ${pt.ratioBps} bps Â· ${fmtUSDC(depositAmt)} USDC deposited to vault`]);
  }

  pushVaultHistory('accept');
  updatePoolUI();
  renderParticipants();
  addLog(`${pt.name} deposited ${fmtUSDC(depositAmt)} USDC (${pt.ratioBps} bps)`, pt.color, 'accept_share', `vault_balance: ${fmtUSDC(S.vaultBalance)} | total_ratio: ${S.totalRatioBps}`);
  toast(`${pt.name} accepted share`, 's');
}

function step_activatePolicy() {
  if (!canDo('activate_policy')) { toast('Leader only','d'); return; }
  if (S.policyState!==2) { toast('Policy must be Funded','w'); return; }
  if (S.totalRatioBps!==10000) { toast('total_ratio must == 10000','d'); return; }
  if (S.vaultBalance<S.payoutAmount) { toast('Vault underfunded','d'); return; }

  S.policyState = 3; // Active
  el('dState').textContent='Active';
  el('claimCard').style.display='block';
  S.claimState = -1;

  markStepDone(5, ['total_ratio == 10000 âœ“','vault_balance >= payout_amount âœ“','timestamp >= active_from âœ“','State: Funded â†’ Active']);
  updatePolicyBadge();
  updatePoolUI();
  addLog(`Policy POL-${S.policyId} is now Active. Oracle monitoring begins.`, '#14F195', 'activate_policy');
  toast('Policy Active â€” Oracle monitoring ON', 's');
}

function step_checkOracle() {
  if (!canDo('check_oracle')) { toast('Insufficient role','d'); return; }
  if (S.policyState!==3) { toast('Policy must be Active','w'); return; }

  const delayVal = parseInt(el('oDelay').value)||0;
  const freshness = parseInt(el('oFreshness').value)||0;
  const errBox = el('oracleErrorBox');
  const sucBox = el('oracleSuccessBox');
  errBox.style.display='none'; sucBox.style.display='none';

  // Validate
  if (freshness > 30) {
    errBox.style.display='block';
    el('oracleErrCode').textContent='E_ORACLE_STALE';
    el('oracleErrMsg').textContent=`Oracle data is ${freshness} min old. Max freshness window: 30 min.`;
    addLog(`Oracle stale. freshness=${freshness}min > 30min`, '#EF4444', 'check_oracle', 'E_ORACLE_STALE');
    toast('E_ORACLE_STALE â€” Oracle data too old','d'); return;
  }
  if (delayVal < 0 || delayVal % 10 !== 0) {
    errBox.style.display='block';
    el('oracleErrCode').textContent='E_ORACLE_FORMAT';
    el('oracleErrMsg').textContent=`delay_min must be >= 0 and divisible by 10. Got: ${delayVal}`;
    addLog(`Oracle format error. delay_min=${delayVal}`, '#EF4444', 'check_oracle', 'E_ORACLE_FORMAT');
    toast('E_ORACLE_FORMAT â€” Invalid delay value','d'); return;
  }

  if (delayVal >= S.threshold) {
    S.policyState = 4; // Claimable
    S.claimState = 1;  // Claimable
    S.claimOracleVal = delayVal;
    S.claimVerifiedAt = nowFull();
    S.claimPayout = S.payoutAmount;

    sucBox.style.display='block';
    el('oracleSuccessMsg').textContent=`TRIGGER MET! delay_min=${delayVal} >= threshold=${S.threshold}. Claim created.`;

    markStepDone(6, [`delay_min=${delayVal} >= threshold=${S.threshold} âœ“`,'Freshness OK âœ“','Format OK âœ“','Claim PDA created','State: Active â†’ Claimable']);
    updatePolicyBadge();
    updateClaimBadge();
    updatePoolUI();
    addLog(`TRIGGER! delay=${delayVal}min >= threshold=${S.threshold}min. Claim CLAIMABLE.`, '#F59E0B', 'check_oracle_and_create_claim', `claim_pda: ${claimPDA().substring(0,16)}...`);
    toast('Claim created â€” Claimable!', 'w');

    // danger flash
    const fl=document.createElement('div');fl.className='danger-flash';document.body.appendChild(fl);
    setTimeout(()=>fl.remove(),1400);
  } else {
    sucBox.style.display='block';
    el('oracleSuccessMsg').textContent=`No trigger. delay_min=${delayVal} < threshold=${S.threshold}. Policy remains Active.`;
    addLog(`No trigger. delay=${delayVal}min < threshold=${S.threshold}min. Policy stays Active.`, '#22C55E', 'check_oracle_and_create_claim');
    toast('No trigger â€” Policy stays Active', 's');
  }
}

function step_approveClaim() {
  if (!canDo('approve_claim')) { toast('Leader or Operator only','d'); return; }
  if (S.claimState!==1) { toast('Claim must be Claimable','w'); return; }

  S.claimState = 2; // Approved
  S.policyState = 5; // Approved
  S.claimApprovedBy = ROLES[currentRole].addr;

  markStepDone(7, ['Claim reviewed by Leader/Operator','Status: Claimable â†’ Approved','Approval record written']);
  updatePolicyBadge();
  updateClaimBadge();
  updatePoolUI();

  addAuditLog('approve', {
    approved_by: ROLES[currentRole].addr.substring(0,16)+'...',
    claim_pda: claimPDA().substring(0,16)+'...',
    oracle_value: S.claimOracleVal+' min',
    payout: fmtUSDC(S.claimPayout)+' USDC',
    timestamp: nowFull(),
  });
  el('auditCard').style.display='block';
  addLog(`Claim approved by ${ROLES[currentRole].label}. Ready for settlement.`, '#22C55E', 'approve_claim');
  toast('Claim approved â€” ready to settle', 's');
}

function step_settleClaim() {
  if (!canDo('settle_claim')) { toast('Leader or Operator only','d'); return; }
  if (S.claimState!==2) { toast('Claim must be Approved','w'); return; }

  const payout = S.payoutAmount;
  S.claimState = 3; // Settled
  S.policyState = 6; // Settled
  S.vaultBalance -= payout;
  if (S.vaultBalance<0n) S.vaultBalance=0n;
  S.paidOut += payout;

  // Proportional losses
  S.participants.forEach(pt => {
    pt.loss = payout * BigInt(pt.ratioBps) / 10000n;
    pt.escrow = pt.escrow - pt.loss;
    if (pt.escrow<0n) pt.escrow=0n;
  });
  S.totalEscrowed = S.participants.reduce((s,p)=>s+p.escrow,0n);

  markStepDone(8, [
    `Payout: ${fmtUSDC(payout)} USDC from vault`,
    ...S.participants.map(pt=>`${pt.name} loss: ${fmtUSDC(pt.loss)} USDC (${pt.ratioBps} bps)`),
    'State: Approved â†’ Settled'
  ]);
  updatePolicyBadge();
  updateClaimBadge();
  updatePoolUI();
  renderParticipants();
  pushVaultHistory('settle');

  addAuditLog('settle', {
    settled_by: ROLES[currentRole].addr.substring(0,16)+'...',
    vault: vaultPDA().substring(0,16)+'...',
    payout_transferred: fmtUSDC(payout)+' USDC',
    vault_remaining: fmtUSDC(S.vaultBalance)+' USDC',
    timestamp: nowFull(),
  });

  addLog(`Settlement executed. ${fmtUSDC(payout)} USDC paid from vault. Losses deducted.`, '#14F195', 'settle_claim',
    S.participants.map(pt=>`${pt.name}: -${fmtUSDC(pt.loss)}`).join(' | ')
  );
  toast(`${fmtUSDC(payout)} USDC settled!`, 's');

  const fl=document.createElement('div');fl.className='danger-flash';document.body.appendChild(fl);
  setTimeout(()=>fl.remove(),1200);
}

function step_expirePolicy() {
  if (!canDo('expire_policy')) { toast('Not authorized','d'); return; }
  S.policyState = 7;
  updatePolicyBadge();
  updatePoolUI();
  addLog('Policy expired. No active claim. Refunds available.', '#94A3B8', 'expire_policy');
  toast('Policy expired â€” refunds available', 'w');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetDemo() {
  S = {
    policyCreated:false, policyId:0, flightNo:'', route:'', depDate:'', depUnix:0,
    threshold:120, payoutAmount:0n, mint:'', oracleFeed:'',
    policyState:-1, uwState:-1, claimState:-1,
    uwOpen:false,
    participants:[
      {id:'leader',name:'Leader',color:'#9945FF',ratioBps:4000,status:'proposed',escrow:0n,loss:0n},
      {id:'partA',name:'Participant A',color:'#14F195',ratioBps:3500,status:'proposed',escrow:0n,loss:0n},
      {id:'partB',name:'Participant B',color:'#F59E0B',ratioBps:2500,status:'proposed',escrow:0n,loss:0n},
    ],
    totalRatioBps:0, vaultBalance:0n, totalEscrowed:0n,
    claimOracleVal:0, claimVerifiedAt:'', claimApprovedBy:'', claimPayout:0n,
    settled:false, paidOut:0n, currentStep:0,
  };
  vaultHistory=[];
  el('policyDetailsCard').style.display='none';
  el('claimCard').style.display='none';
  el('auditCard').style.display='none';
  el('policyIdDisplay').textContent='POL-â€”';
  el('builderCard').querySelector('.card-body').style.opacity='1';
  el('builderCard').querySelector('.card-body').style.pointerEvents='auto';
  el('oracleErrorBox').style.display='none';
  el('oracleSuccessBox').style.display='none';
  el('eventLog').innerHTML='<div class="log-entry"><div class="log-dot" style="background:var(--sub);"></div><span class="log-time">--:--:--</span><div class="log-body" style="color:var(--sub);">Demo reset. Ready.</div></div>';
  el('auditLog').innerHTML='<div style="font-size:10px;color:var(--sub);">No approval records yet.</div>';
  el('inspectorPanel').innerHTML='<div style="font-size:10px;color:var(--sub);text-align:center;padding:20px;">Create a policy to inspect accounts.</div>';
  renderSteps();
  renderStateMachine();
  renderParticipants();
  updatePoolUI();
  initPieChart();
  initVaultChart();
  updateKPIs();
  toast('Demo reset','i');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, type='i') {
  const t=el('toast');
  el('toastMsg').textContent=msg;
  t.className='toast show '+type;
  clearTimeout(t._ti);
  t._ti=setTimeout(()=>t.classList.remove('show'),3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function el(id){return document.getElementById(id);}

setInterval(()=>{
  const ping=Math.floor(Math.random()*20+6);
  // could update a ping display if desired
},3000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.onload = () => {
  renderSteps();
  renderStateMachine();
  renderParticipants();
  initPieChart();
  initVaultChart();
  updateKPIs();
  updateButtonPermissions();
  addLog('OpenParametric Protocol initialized. Solana devnet.', '#9945FF', 'system_init', 'Awaiting create_policy instruction.');
};

document.getElementById('oracleModal')?.addEventListener('click',e=>{if(e.target===e.currentTarget)e.target.classList.remove('show');});
</script>


</body></html>